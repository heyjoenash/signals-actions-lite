<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personas - Signals & Actions</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- Swiss Design System -->
    <link rel="stylesheet" href="styles/swiss-design.css">
    
    <!-- Components -->
    <script src="components/breadcrumb.js"></script>
    
    <style>
        /* Page-specific styles */
        .persona-card {
            background: white;
            border: 1px solid var(--color-slate-200);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            transition: all 0.2s ease;
            position: relative;
        }
        .persona-card:hover {
            border-color: var(--color-blue-500);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .persona-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }
        .criteria-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--color-slate-100);
            border-radius: 16px;
            font-size: var(--font-size-xs);
            margin: 2px;
        }
        .seniority-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        .seniority-senior { background: var(--color-amber-500); }
        .seniority-mid { background: var(--color-blue-500); }
        .seniority-junior { background: var(--color-green-500); }
    </style>
</head>
<body class="has-sidebar page-with-sidebar">
    <div id="app" class="min-h-screen">
        <!-- Sidebar Navigation -->
        <div id="sidebar-container"></div>
        
        <!-- Mobile Sidebar Toggle -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Page Header -->
            <div class="mb-6">
                <div id="breadcrumb-container"></div>
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">Personas</h1>
                        <div class="text-sm text-muted">Define target personas for outreach and engagement</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="app.showTemplatesModal()" class="btn btn-secondary">
                            <i class="fas fa-magic mr-2"></i>Use Template
                        </button>
                        <button onclick="app.showCreateModal()" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Create Persona
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="metric-card text-center">
                    <div class="text-2xl font-semibold text-slate-900" id="stat-total">0</div>
                    <div class="text-xs text-muted">Total Personas</div>
                </div>
                <div class="metric-card text-center">
                    <div class="text-2xl font-semibold text-blue-600" id="stat-active">0</div>
                    <div class="text-xs text-muted">Active</div>
                </div>
                <div class="metric-card text-center">
                    <div class="text-2xl font-semibold text-amber-600" id="stat-matched">0</div>
                    <div class="text-xs text-muted">Matched People</div>
                </div>
                <div class="metric-card text-center">
                    <div class="text-2xl font-semibold text-green-600" id="stat-high-value">0</div>
                    <div class="text-xs text-muted">High Value Matches</div>
                </div>
            </div>

            <!-- Personas Grid -->
            <div id="personasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center py-12 text-muted col-span-full">
                    <i class="fas fa-user-tag text-4xl mb-4 opacity-20"></i>
                    <p>No personas created yet</p>
                    <p class="text-sm mt-2">Create your first persona or use a template</p>
                </div>
            </div>

            <!-- Create/Edit Modal -->
            <div id="personaModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold mb-4" id="modalTitle">Create Persona</h3>
                    
                    <form id="personaForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Persona Name</label>
                                <input type="text" id="personaName" required
                                       class="w-full px-3 py-2 border border-slate-200 rounded focus:outline-none focus:border-blue-500"
                                       placeholder="e.g. Enterprise Decision Maker">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Icon Color</label>
                                <select id="iconColor" class="w-full px-3 py-2 border border-slate-200 rounded">
                                    <option value="blue">Blue</option>
                                    <option value="amber">Amber</option>
                                    <option value="green">Green</option>
                                    <option value="purple">Purple</option>
                                    <option value="red">Red</option>
                                    <option value="slate">Slate</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-sm font-medium text-slate-700 block mb-1">Description</label>
                            <textarea id="personaDescription" rows="2"
                                      class="w-full px-3 py-2 border border-slate-200 rounded text-sm"
                                      placeholder="Brief description of this persona"></textarea>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-slate-900 mb-3">Title Criteria</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-slate-700 block mb-1">Must Include Keywords</label>
                                    <div class="flex gap-2 mb-2">
                                        <input type="text" id="includeKeyword" 
                                               class="flex-1 px-3 py-2 border border-slate-200 rounded text-sm"
                                               placeholder="e.g. CEO, Director">
                                        <button type="button" onclick="app.addKeyword('include')" class="btn btn-secondary text-sm">
                                            Add
                                        </button>
                                    </div>
                                    <div id="includeKeywords" class="flex flex-wrap gap-1"></div>
                                </div>
                                <div>
                                    <label class="text-sm text-slate-700 block mb-1">Must Exclude Keywords</label>
                                    <div class="flex gap-2 mb-2">
                                        <input type="text" id="excludeKeyword" 
                                               class="flex-1 px-3 py-2 border border-slate-200 rounded text-sm"
                                               placeholder="e.g. Assistant, Junior">
                                        <button type="button" onclick="app.addKeyword('exclude')" class="btn btn-secondary text-sm">
                                            Add
                                        </button>
                                    </div>
                                    <div id="excludeKeywords" class="flex flex-wrap gap-1"></div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label class="text-sm text-slate-700 block mb-1">Seniority Levels</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="seniorLevel" value="senior">
                                        <span class="text-sm">Senior (C-level, VP+)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="midLevel" value="mid">
                                        <span class="text-sm">Mid-level (Manager, Director)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="juniorLevel" value="junior">
                                        <span class="text-sm">Junior (Individual Contributor)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-slate-900 mb-3">Company Criteria</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-slate-700 block mb-1">Industry</label>
                                    <select id="industryFilter" class="w-full px-3 py-2 border border-slate-200 rounded text-sm">
                                        <option value="">Any Industry</option>
                                        <option value="technology">Technology</option>
                                        <option value="finance">Finance & Banking</option>
                                        <option value="healthcare">Healthcare</option>
                                        <option value="retail">Retail & E-commerce</option>
                                        <option value="manufacturing">Manufacturing</option>
                                        <option value="consulting">Consulting</option>
                                        <option value="education">Education</option>
                                        <option value="media">Media & Entertainment</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-slate-700 block mb-1">Company Size</label>
                                    <select id="companySizeFilter" class="w-full px-3 py-2 border border-slate-200 rounded text-sm">
                                        <option value="">Any Size</option>
                                        <option value="startup">Startup (1-50)</option>
                                        <option value="small">Small (51-200)</option>
                                        <option value="mid">Mid-size (201-1000)</option>
                                        <option value="large">Large (1001-5000)</option>
                                        <option value="enterprise">Enterprise (5000+)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label class="text-sm text-slate-700 block mb-1">Location</label>
                                <input type="text" id="locationFilter" 
                                       class="w-full px-3 py-2 border border-slate-200 rounded text-sm"
                                       placeholder="e.g. United States, San Francisco Bay Area">
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-slate-900 mb-3">Engagement Criteria</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-slate-700 block mb-1">Minimum Engagement Score</label>
                                    <input type="number" id="minEngagementScore" min="0" max="20" value="0"
                                           class="w-full px-3 py-2 border border-slate-200 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-sm text-slate-700 block mb-1">Follower Status</label>
                                    <select id="followerStatus" class="w-full px-3 py-2 border border-slate-200 rounded text-sm">
                                        <option value="any">Any</option>
                                        <option value="follower">Must be Follower</option>
                                        <option value="non-follower">Non-followers Only</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="isActive" checked>
                            <label for="isActive" class="text-sm text-slate-700">Active persona</label>
                        </div>
                        
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button type="button" onclick="app.closeModal()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Save Persona
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Templates Modal -->
            <div id="templatesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold mb-4">Persona Templates</h3>
                    
                    <div class="grid gap-4">
                        <div class="p-4 border border-slate-200 rounded-lg cursor-pointer hover:border-blue-500" 
                             onclick="app.useTemplate('enterprise-decision-maker')">
                            <h4 class="font-semibold text-sm mb-1">Enterprise Decision Maker</h4>
                            <p class="text-xs text-muted">C-level executives at large companies who make strategic decisions</p>
                        </div>
                        
                        <div class="p-4 border border-slate-200 rounded-lg cursor-pointer hover:border-blue-500" 
                             onclick="app.useTemplate('tech-innovator')">
                            <h4 class="font-semibold text-sm mb-1">Tech Innovator</h4>
                            <p class="text-xs text-muted">CTOs, VPs of Engineering, and tech leaders driving innovation</p>
                        </div>
                        
                        <div class="p-4 border border-slate-200 rounded-lg cursor-pointer hover:border-blue-500" 
                             onclick="app.useTemplate('sales-leader')">
                            <h4 class="font-semibold text-sm mb-1">Sales Leader</h4>
                            <p class="text-xs text-muted">VPs of Sales and Sales Directors focused on revenue growth</p>
                        </div>
                        
                        <div class="p-4 border border-slate-200 rounded-lg cursor-pointer hover:border-blue-500" 
                             onclick="app.useTemplate('marketing-executive')">
                            <h4 class="font-semibold text-sm mb-1">Marketing Executive</h4>
                            <p class="text-xs text-muted">CMOs and Marketing VPs driving brand and demand generation</p>
                        </div>
                        
                        <div class="p-4 border border-slate-200 rounded-lg cursor-pointer hover:border-blue-500" 
                             onclick="app.useTemplate('startup-founder')">
                            <h4 class="font-semibold text-sm mb-1">Startup Founder</h4>
                            <p class="text-xs text-muted">Founders and Co-founders of early to mid-stage startups</p>
                        </div>
                    </div>
                    
                    <button onclick="app.closeTemplatesModal()" class="mt-4 text-sm text-muted hover:text-slate-900">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let supabaseClient;
        let currentPersona = null;
        let personas = [];
        let keywords = {
            include: [],
            exclude: []
        };
        
        // Persona templates
        const PERSONA_TEMPLATES = {
            'enterprise-decision-maker': {
                name: 'Enterprise Decision Maker',
                description: 'C-level executives at large companies who make strategic decisions',
                iconColor: 'amber',
                titleKeywords: {
                    include: ['CEO', 'CTO', 'CFO', 'COO', 'CMO', 'CIO', 'Chief', 'President'],
                    exclude: ['Assistant', 'Associate', 'Junior']
                },
                seniority: ['senior'],
                companyCriteria: {
                    size: 'enterprise',
                    industry: ''
                },
                minEngagementScore: 5,
                followerStatus: 'any'
            },
            'tech-innovator': {
                name: 'Tech Innovator',
                description: 'Technology leaders driving innovation and digital transformation',
                iconColor: 'blue',
                titleKeywords: {
                    include: ['CTO', 'VP Engineering', 'Director Engineering', 'Head of Technology', 'Tech Lead'],
                    exclude: ['Junior', 'Intern']
                },
                seniority: ['senior', 'mid'],
                companyCriteria: {
                    size: '',
                    industry: 'technology'
                },
                minEngagementScore: 3,
                followerStatus: 'any'
            },
            'sales-leader': {
                name: 'Sales Leader',
                description: 'Sales executives focused on revenue growth and team performance',
                iconColor: 'green',
                titleKeywords: {
                    include: ['VP Sales', 'Sales Director', 'Head of Sales', 'Revenue Officer'],
                    exclude: ['Rep', 'Associate', 'Coordinator']
                },
                seniority: ['senior', 'mid'],
                companyCriteria: {
                    size: '',
                    industry: ''
                },
                minEngagementScore: 3,
                followerStatus: 'any'
            },
            'marketing-executive': {
                name: 'Marketing Executive',
                description: 'Marketing leaders driving brand strategy and demand generation',
                iconColor: 'purple',
                titleKeywords: {
                    include: ['CMO', 'VP Marketing', 'Marketing Director', 'Head of Marketing', 'Brand Director'],
                    exclude: ['Coordinator', 'Assistant', 'Intern']
                },
                seniority: ['senior', 'mid'],
                companyCriteria: {
                    size: '',
                    industry: ''
                },
                minEngagementScore: 3,
                followerStatus: 'any'
            },
            'startup-founder': {
                name: 'Startup Founder',
                description: 'Founders and co-founders of early to mid-stage startups',
                iconColor: 'red',
                titleKeywords: {
                    include: ['Founder', 'Co-founder', 'CEO', 'Founding'],
                    exclude: []
                },
                seniority: ['senior'],
                companyCriteria: {
                    size: 'startup',
                    industry: ''
                },
                minEngagementScore: 2,
                followerStatus: 'any'
            }
        };
        
        // Main application object
        const app = {
            async init() {
                // Initialize breadcrumb
                BreadcrumbManager.inject(BreadcrumbManager.getPath('personas'));
                
                // Set up form handler
                document.getElementById('personaForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePersona();
                });
                
                // Load personas
                await this.loadPersonas();
                
                // Render
                this.render();
            },
            
            async loadPersonas() {
                try {
                    // For now, use mock data since personas table doesn't exist yet
                    personas = [
                        {
                            id: 'persona_1',
                            name: 'Enterprise Decision Maker',
                            description: 'C-level executives at Fortune 500 companies',
                            icon_color: 'amber',
                            title_keywords: {
                                include: ['CEO', 'CTO', 'CFO', 'President', 'Chief'],
                                exclude: ['Assistant', 'Junior']
                            },
                            seniority_levels: ['senior'],
                            company_criteria: {
                                industry: 'technology',
                                size: 'enterprise',
                                location: 'United States'
                            },
                            engagement_criteria: {
                                min_score: 5,
                                follower_status: 'any'
                            },
                            is_active: true,
                            created_date: new Date('2025-01-08').toISOString(),
                            matched_count: 42
                        },
                        {
                            id: 'persona_2',
                            name: 'Tech Innovator',
                            description: 'Technology leaders driving digital transformation',
                            icon_color: 'blue',
                            title_keywords: {
                                include: ['VP Engineering', 'Director', 'Head of Technology'],
                                exclude: ['Intern']
                            },
                            seniority_levels: ['senior', 'mid'],
                            company_criteria: {
                                industry: 'technology',
                                size: 'mid',
                                location: 'San Francisco Bay Area'
                            },
                            engagement_criteria: {
                                min_score: 3,
                                follower_status: 'follower'
                            },
                            is_active: true,
                            created_date: new Date('2025-01-07').toISOString(),
                            matched_count: 87
                        }
                    ];
                    
                } catch (error) {
                    console.error('Error loading personas:', error);
                }
            },
            
            render() {
                this.updateStats();
                this.renderPersonas();
            },
            
            updateStats() {
                const stats = {
                    total: personas.length,
                    active: personas.filter(p => p.is_active).length,
                    matched: personas.reduce((sum, p) => sum + (p.matched_count || 0), 0),
                    highValue: Math.floor(personas.reduce((sum, p) => sum + (p.matched_count || 0), 0) * 0.3)
                };
                
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-active').textContent = stats.active;
                document.getElementById('stat-matched').textContent = stats.matched;
                document.getElementById('stat-high-value').textContent = stats.highValue;
            },
            
            renderPersonas() {
                const container = document.getElementById('personasGrid');
                
                if (personas.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-muted col-span-full">
                            <i class="fas fa-user-tag text-4xl mb-4 opacity-20"></i>
                            <p>No personas created yet</p>
                            <p class="text-sm mt-2">Create your first persona or use a template</p>
                        </div>
                    `;
                    return;
                }
                
                const getColorClass = (color) => {
                    const colors = {
                        blue: 'bg-blue-500',
                        amber: 'bg-amber-500',
                        green: 'bg-green-500',
                        purple: 'bg-purple-500',
                        red: 'bg-red-500',
                        slate: 'bg-slate-500'
                    };
                    return colors[color] || 'bg-blue-500';
                };
                
                container.innerHTML = personas.map(persona => `
                    <div class="persona-card cursor-pointer" onclick="app.editPersona('${persona.id}')">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="persona-icon ${getColorClass(persona.icon_color)}">
                                <i class="fas fa-user-tag"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-slate-900">${persona.name}</h3>
                                <p class="text-sm text-muted">${persona.description || 'No description'}</p>
                                <div class="flex items-center gap-3 mt-2">
                                    <span class="data-pill ${persona.is_active ? 'low' : ''}">
                                        ${persona.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                    <span class="text-xs text-muted">
                                        ${persona.matched_count || 0} matches
                                    </span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); app.duplicatePersona('${persona.id}')" 
                                        class="text-slate-400 hover:text-slate-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="event.stopPropagation(); app.deletePersona('${persona.id}')" 
                                        class="text-red-400 hover:text-red-600">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            ${persona.title_keywords?.include?.length > 0 ? `
                                <div class="flex items-start gap-2">
                                    <span class="text-xs text-muted mt-1">Titles:</span>
                                    <div class="flex flex-wrap gap-1">
                                        ${persona.title_keywords.include.map(k => 
                                            `<span class="criteria-tag">${k}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex items-start gap-2">
                                <span class="text-xs text-muted mt-1">Seniority:</span>
                                <div class="flex items-center gap-2">
                                    ${persona.seniority_levels?.map(level => `
                                        <span class="flex items-center gap-1 text-xs">
                                            <span class="seniority-indicator seniority-${level}"></span>
                                            ${level.charAt(0).toUpperCase() + level.slice(1)}
                                        </span>
                                    `).join('') || '<span class="text-xs text-muted">Any</span>'}
                                </div>
                            </div>
                            
                            ${persona.company_criteria ? `
                                <div class="flex flex-wrap gap-1">
                                    ${persona.company_criteria.industry ? 
                                        `<span class="criteria-tag">${persona.company_criteria.industry}</span>` : ''}
                                    ${persona.company_criteria.size ? 
                                        `<span class="criteria-tag">${persona.company_criteria.size}</span>` : ''}
                                    ${persona.company_criteria.location ? 
                                        `<span class="criteria-tag">${persona.company_criteria.location}</span>` : ''}
                                </div>
                            ` : ''}
                            
                            ${persona.engagement_criteria?.min_score > 0 ? `
                                <div class="text-xs text-muted">
                                    Min engagement score: ${persona.engagement_criteria.min_score}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-100">
                            <span class="text-xs text-muted">
                                Created ${new Date(persona.created_date).toLocaleDateString()}
                            </span>
                            <button onclick="event.stopPropagation(); app.testPersona('${persona.id}')" 
                                    class="text-xs text-blue-600 hover:text-blue-800">
                                Test Match
                            </button>
                        </div>
                    </div>
                `).join('');
            },
            
            showCreateModal() {
                currentPersona = null;
                keywords = { include: [], exclude: [] };
                document.getElementById('modalTitle').textContent = 'Create Persona';
                document.getElementById('personaForm').reset();
                document.getElementById('includeKeywords').innerHTML = '';
                document.getElementById('excludeKeywords').innerHTML = '';
                document.getElementById('personaModal').classList.remove('hidden');
            },
            
            async editPersona(personaId) {
                const persona = personas.find(p => p.id === personaId);
                if (!persona) return;
                
                currentPersona = persona;
                keywords = {
                    include: persona.title_keywords?.include || [],
                    exclude: persona.title_keywords?.exclude || []
                };
                
                // Populate form
                document.getElementById('modalTitle').textContent = 'Edit Persona';
                document.getElementById('personaName').value = persona.name;
                document.getElementById('iconColor').value = persona.icon_color || 'blue';
                document.getElementById('personaDescription').value = persona.description || '';
                
                // Seniority levels
                document.getElementById('seniorLevel').checked = persona.seniority_levels?.includes('senior');
                document.getElementById('midLevel').checked = persona.seniority_levels?.includes('mid');
                document.getElementById('juniorLevel').checked = persona.seniority_levels?.includes('junior');
                
                // Company criteria
                document.getElementById('industryFilter').value = persona.company_criteria?.industry || '';
                document.getElementById('companySizeFilter').value = persona.company_criteria?.size || '';
                document.getElementById('locationFilter').value = persona.company_criteria?.location || '';
                
                // Engagement criteria
                document.getElementById('minEngagementScore').value = persona.engagement_criteria?.min_score || 0;
                document.getElementById('followerStatus').value = persona.engagement_criteria?.follower_status || 'any';
                
                document.getElementById('isActive').checked = persona.is_active;
                
                // Render keywords
                this.renderKeywords();
                
                document.getElementById('personaModal').classList.remove('hidden');
            },
            
            addKeyword(type) {
                const input = document.getElementById(`${type}Keyword`);
                const value = input.value.trim();
                
                if (value && !keywords[type].includes(value)) {
                    keywords[type].push(value);
                    input.value = '';
                    this.renderKeywords();
                }
            },
            
            removeKeyword(type, index) {
                keywords[type].splice(index, 1);
                this.renderKeywords();
            },
            
            renderKeywords() {
                // Include keywords
                document.getElementById('includeKeywords').innerHTML = keywords.include.map((k, i) => `
                    <span class="criteria-tag">
                        ${k}
                        <i class="fas fa-times cursor-pointer ml-1" onclick="app.removeKeyword('include', ${i})"></i>
                    </span>
                `).join('');
                
                // Exclude keywords
                document.getElementById('excludeKeywords').innerHTML = keywords.exclude.map((k, i) => `
                    <span class="criteria-tag">
                        ${k}
                        <i class="fas fa-times cursor-pointer ml-1" onclick="app.removeKeyword('exclude', ${i})"></i>
                    </span>
                `).join('');
            },
            
            async savePersona() {
                // Get seniority levels
                const seniorityLevels = [];
                if (document.getElementById('seniorLevel').checked) seniorityLevels.push('senior');
                if (document.getElementById('midLevel').checked) seniorityLevels.push('mid');
                if (document.getElementById('juniorLevel').checked) seniorityLevels.push('junior');
                
                const formData = {
                    name: document.getElementById('personaName').value,
                    description: document.getElementById('personaDescription').value,
                    icon_color: document.getElementById('iconColor').value,
                    title_keywords: {
                        include: keywords.include,
                        exclude: keywords.exclude
                    },
                    seniority_levels: seniorityLevels,
                    company_criteria: {
                        industry: document.getElementById('industryFilter').value,
                        size: document.getElementById('companySizeFilter').value,
                        location: document.getElementById('locationFilter').value
                    },
                    engagement_criteria: {
                        min_score: parseInt(document.getElementById('minEngagementScore').value) || 0,
                        follower_status: document.getElementById('followerStatus').value
                    },
                    is_active: document.getElementById('isActive').checked
                };
                
                try {
                    if (currentPersona) {
                        // Update existing
                        const index = personas.findIndex(p => p.id === currentPersona.id);
                        if (index !== -1) {
                            personas[index] = { ...personas[index], ...formData };
                        }
                    } else {
                        // Create new
                        const newPersona = {
                            ...formData,
                            id: `persona_${Date.now()}`,
                            created_date: new Date().toISOString(),
                            matched_count: 0
                        };
                        personas.push(newPersona);
                    }
                    
                    this.render();
                    this.closeModal();
                    
                    // Show success message
                    alert(`Persona ${currentPersona ? 'updated' : 'created'} successfully!`);
                    
                } catch (error) {
                    console.error('Error saving persona:', error);
                    alert('Failed to save persona');
                }
            },
            
            async deletePersona(personaId) {
                if (!confirm('Are you sure you want to delete this persona?')) return;
                
                personas = personas.filter(p => p.id !== personaId);
                this.render();
                alert('Persona deleted successfully');
            },
            
            async duplicatePersona(personaId) {
                const persona = personas.find(p => p.id === personaId);
                if (!persona) return;
                
                const duplicate = {
                    ...persona,
                    id: `persona_${Date.now()}`,
                    name: `${persona.name} (Copy)`,
                    created_date: new Date().toISOString(),
                    matched_count: 0
                };
                
                personas.push(duplicate);
                this.render();
            },
            
            async testPersona(personaId) {
                const persona = personas.find(p => p.id === personaId);
                if (!persona) return;
                
                // In a real implementation, this would query the persons table
                alert(`Testing persona "${persona.name}"...\n\nThis would show matching people based on:\n- Title keywords\n- Seniority levels\n- Company criteria\n- Engagement score\n\nMatched: ${persona.matched_count || 0} people`);
            },
            
            closeModal() {
                document.getElementById('personaModal').classList.add('hidden');
            },
            
            showTemplatesModal() {
                document.getElementById('templatesModal').classList.remove('hidden');
            },
            
            closeTemplatesModal() {
                document.getElementById('templatesModal').classList.add('hidden');
            },
            
            useTemplate(templateId) {
                const template = PERSONA_TEMPLATES[templateId];
                if (!template) return;
                
                // Reset form and populate with template
                currentPersona = null;
                keywords = template.titleKeywords;
                
                document.getElementById('modalTitle').textContent = 'Create Persona from Template';
                document.getElementById('personaName').value = template.name;
                document.getElementById('iconColor').value = template.iconColor;
                document.getElementById('personaDescription').value = template.description;
                
                // Seniority
                document.getElementById('seniorLevel').checked = template.seniority.includes('senior');
                document.getElementById('midLevel').checked = template.seniority.includes('mid');
                document.getElementById('juniorLevel').checked = template.seniority.includes('junior');
                
                // Company criteria
                document.getElementById('industryFilter').value = template.companyCriteria.industry;
                document.getElementById('companySizeFilter').value = template.companyCriteria.size;
                document.getElementById('locationFilter').value = '';
                
                // Engagement
                document.getElementById('minEngagementScore').value = template.minEngagementScore;
                document.getElementById('followerStatus').value = template.followerStatus;
                
                document.getElementById('isActive').checked = true;
                
                this.renderKeywords();
                
                // Close templates modal and open persona modal
                this.closeTemplatesModal();
                document.getElementById('personaModal').classList.remove('hidden');
            }
        };
        
        // Load sidebar component
        async function loadSidebar() {
            try {
                const response = await fetch('components/sidebar.html');
                const sidebarHTML = await response.text();
                document.getElementById('sidebar-container').innerHTML = sidebarHTML;
            } catch (error) {
                console.error('Failed to load sidebar:', error);
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Load sidebar first
            await loadSidebar();
            
            // Initialize Supabase client
            supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            
            // Initialize app
            window.app = app;
            app.init();
        });
    </script>
</body>
</html>