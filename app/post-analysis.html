<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Analysis - Signals & Actions</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- LinkedIn API Service -->
    <script src="services/linkedin-api.js"></script>
    
    <!-- Swiss Design System -->
    <link rel="stylesheet" href="styles/swiss-design.css">
    
    <style>
        /* Page-specific overrides only - main styles in swiss-design.css */
    </style>
</head>
<body class="has-sidebar page-with-sidebar">
    <div id="app" class="min-h-screen">
        <!-- Sidebar Navigation -->
        <div id="sidebar-container"></div>
        
        <!-- Mobile Sidebar Toggle -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Page Header with Actions -->
        <div class="main-content">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-xl font-semibold text-gray-900">Post Analysis</h1>
                    <div class="text-sm text-muted">LinkedIn Engagement Analytics</div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="app.toggleReviewMode()" class="btn btn-primary">
                        Review Mode
                    </button>
                    <button onclick="app.exportEngagements()" class="btn btn-secondary">
                        Export
                    </button>
                </div>
            </div>

        <!-- Main Content -->
        <main>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Post Details -->
                <div class="lg:col-span-1">
                    <!-- Post Display -->
                    <div class="metric-card mb-6">
                        <h3 class="text-strong text-base mb-4">Post Content</h3>
                        <div id="postEmbed">
                            <div class="skeleton h-96 rounded"></div>
                        </div>
                    </div>
                    
                    <!-- Engagement Overview -->
                    <div class="metric-card mb-6">
                        <h3 class="text-strong text-base mb-4">Overview</h3>
                        <div id="postMetrics">
                            <div class="skeleton h-20 rounded"></div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Right Column: Engagements -->
                <div class="lg:col-span-2">
                    <!-- Pattern Analysis (Moved from left column) -->
                    <div class="metric-card mb-6">
                        <h3 class="text-strong text-base mb-4">Patterns & Insights</h3>
                        <div id="patternsAndSignals">
                            <!-- Dynamically populated patterns and top signal -->
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="metric-card mb-6">
                        <!-- Filter Tabs -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button class="filter-tab active" onclick="app.setFilter('all')">
                                All <span id="countAll" class="ml-1 text-mono">0</span>
                            </button>
                            <button class="filter-tab" onclick="app.setFilter('followers')">
                                Followers <span id="countFollowers" class="ml-1 text-mono">0</span>
                            </button>
                            <button class="filter-tab" onclick="app.setFilter('target_titles')">
                                Target <span id="countTargetTitles" class="ml-1 text-mono">0</span>
                            </button>
                            <button class="filter-tab" onclick="app.setFilter('high_value')">
                                High Value <span id="countHighValue" class="ml-1 text-mono">0</span>
                            </button>
                            <button class="filter-tab" onclick="app.setFilter('notable')">
                                Notable <span id="countNotable" class="ml-1 text-mono">0</span>
                            </button>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="companyFilter" onchange="app.applyFilters()" class="control-select">
                                <option value="">All Companies</option>
                            </select>
                            <select id="titleFilter" onchange="app.applyFilters()" class="control-select">
                                <option value="">All Titles</option>
                            </select>
                            <select id="actionStatusFilter" onchange="app.applyFilters()" class="control-select">
                                <option value="">All Statuses</option>
                                <option value="new">New</option>
                                <option value="viewed">Viewed</option>
                                <option value="messaged">Messaged</option>
                                <option value="responded">Responded</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Search (Compact) -->
                    <div class="metric-card mb-6">
                        <div class="relative">
                            <svg class="icon icon-sm absolute left-3 top-2.5 text-muted" viewBox="0 0 24 24">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            <input type="text" 
                                   id="searchInput"
                                   placeholder="Search people, titles, companies..." 
                                   class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded focus:outline-none focus:border-blue-500 text-sm">
                        </div>
                    </div>
                    
                    <!-- Data Table -->
                    <div class="data-table">
                        <table class="w-full" style="table-layout: fixed;">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">
                                        <button onclick="app.sortBy('name')" class="flex items-center gap-2 hover:text-slate-900">
                                            Person
                                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                                <path d="M8 9l4-4 4 4"></path>
                                                <path d="M16 15l-4 4-4-4"></path>
                                            </svg>
                                        </button>
                                    </th>
                                    <th style="width: 20%;">
                                        <button onclick="app.sortBy('title')" class="flex items-center gap-2 hover:text-slate-900">
                                            Title
                                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                                <path d="M8 9l4-4 4 4"></path>
                                                <path d="M16 15l-4 4-4-4"></path>
                                            </svg>
                                        </button>
                                    </th>
                                    <th style="width: 20%;">
                                        <button onclick="app.sortBy('company')" class="flex items-center gap-2 hover:text-slate-900">
                                            Company
                                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                                <path d="M8 9l4-4 4 4"></path>
                                                <path d="M16 15l-4 4-4-4"></path>
                                            </svg>
                                        </button>
                                    </th>
                                    <th style="width: 10%;">
                                        <button onclick="app.sortBy('engagement_score')" class="flex items-center gap-2 hover:text-slate-900">
                                            Signal
                                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                                <path d="M8 9l4-4 4 4"></path>
                                                <path d="M16 15l-4 4-4-4"></path>
                                            </svg>
                                        </button>
                                    </th>
                                    <th style="width: 15%;">Status</th>
                                    <th style="width: 10%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="engagementsTable">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-muted">
                                        <div class="flex justify-center">
                                            <div class="w-6 h-6 border-2 border-slate-200 border-t-slate-600 rounded-full animate-spin"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                        
                        <!-- Pagination -->
                        <div class="px-4 py-3 bg-gray-50 border-t flex items-center justify-between">
                            <div class="text-sm text-gray-700">
                                Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalResults">0</span> results
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.previousPage()" class="px-3 py-1 text-sm bg-white border rounded hover:bg-gray-50">
                                    Previous
                                </button>
                                <button onclick="app.nextPage()" class="px-3 py-1 text-sm bg-white border rounded hover:bg-gray-50">
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Review Panel -->
        <div id="reviewModePanel" class="review-panel hidden">
            <h3 class="text-strong mb-2">Title Discovery</h3>
            <p class="text-xs text-muted mb-4">
                Find new job titles to target from your engagements.
            </p>
            <div id="discoveredTitles" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- Dynamically populated -->
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                <button onclick="app.addSelectedTitles()" class="w-full py-3 bg-slate-900 text-white rounded text-sm font-medium hover:bg-slate-800 transition-colors">
                    Add Selected Titles
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        let supabaseClient;
        
        // Application state
        const app = {
            postId: null,
            post: null,
            engagements: [],
            filteredEngagements: [],
            currentFilter: 'all',
            currentPage: 1,
            pageSize: 50,
            reviewMode: false,
            targetTitles: ['CEO', 'CTO', 'VP', 'Director', 'Manager', 'Head of', 'Chief', 'Founder', 'Co-founder'],
            currentSort: null,
            sortDirection: 'asc',
            
            async init() {
                // Get post ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.postId = urlParams.get('id');
                
                if (!this.postId) {
                    alert('No post ID provided');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Initialize Supabase
                supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                
                // Load data
                await this.loadPost();
                await this.loadEngagements();
                this.renderPost();
                this.renderMetrics();
                this.renderSignals();
                this.populateFilters();
                this.applyFilters();
                
                // Setup event listeners
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.applyFilters();
                });
            },
            
            async loadPost() {
                console.log('Loading post with ID:', this.postId);
                const { data, error } = await supabaseClient
                    .from('posts')
                    .select('*')
                    .eq('id', this.postId)
                    .single();
                
                if (error) {
                    console.error('Error loading post:', error);
                    alert('Failed to load post: ' + error.message);
                    return;
                }
                
                console.log('✅ Loaded post:', data);
                this.post = data;
            },
            
            async loadEngagements() {
                console.log('🔍 Loading engagements for post ID:', this.postId);
                
                // First, let's check total engagements for this post without join
                const { data: totalCount, error: countError } = await supabaseClient
                    .from('engagements')
                    .select('id', { count: 'exact' })
                    .eq('post_id', this.postId);
                    
                console.log('📊 Total engagements in DB for post:', totalCount?.length || 0);
                
                const { data, error } = await supabaseClient
                    .from('engagements')
                    .select(`
                        *,
                        person:persons (
                            id,
                            name,
                            linkedin_url,
                            profile_picture,
                            current_title,
                            title_override,
                            current_company,
                            company_override,
                            headline,
                            is_follower,
                            engagement_score,
                            lead_status,
                            is_notable,
                            notable_reason
                        )
                    `)
                    .eq('post_id', this.postId)
                    .order('engaged_at', { ascending: false });
                
                if (error) {
                    console.error('❌ Error loading engagements:', error);
                    return;
                }
                
                console.log('✅ Loaded engagements with person data:', data?.length || 0);
                
                // Check for missing person data
                const missingPersonData = data?.filter(e => !e.person) || [];
                if (missingPersonData.length > 0) {
                    console.log('⚠️ Engagements missing person data:', missingPersonData.length);
                    console.log('Sample missing person engagement:', missingPersonData[0]);
                }
                
                if (data && data.length > 0) {
                    console.log('📋 Sample engagement with person:', data[0]);
                }
                
                console.log('🎯 Expected ~283 from Apify, got:', data?.length || 0);
                
                this.engagements = data || [];
                this.filteredEngagements = [...this.engagements];
                
                // Additional diagnosis for the 162 vs 283 discrepancy
                if (data) {
                    const withPersonData = data.filter(e => e.person);
                    const withoutPersonData = data.filter(e => !e.person);
                    console.log('📊 DATA BREAKDOWN:');
                    console.log('  - Total engagements loaded:', data.length);
                    console.log('  - With person data:', withPersonData.length);  
                    console.log('  - Without person data:', withoutPersonData.length);
                    console.log('  - Expected from Apify: 283');
                    console.log('  - Showing in UI: ' + withPersonData.length + ' (filtered out ' + withoutPersonData.length + ' missing persons)');
                }
            },
            
            renderPost() {
                const embedContainer = document.getElementById('postEmbed');
                
                if (!this.post) {
                    embedContainer.innerHTML = '<p class="text-muted">Post data not loaded</p>';
                    return;
                }
                
                if (this.post.linkedin_url || this.post.url) {
                    const url = this.post.linkedin_url || this.post.url;
                    // Extract post ID from LinkedIn URL
                    const postIdMatch = url.match(/activity-(\d+)/);
                    if (postIdMatch) {
                        embedContainer.innerHTML = `
                            <iframe src="https://www.linkedin.com/embed/feed/update/urn:li:activity:${postIdMatch[1]}" 
                                    height="500" 
                                    width="100%" 
                                    frameborder="0" 
                                    allowfullscreen=""
                                    class="rounded border border-slate-200">
                            </iframe>
                        `;
                    } else {
                        embedContainer.innerHTML = `
                            <div class="text-center py-12 border border-slate-200 rounded">
                                <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                                    <rect x="2" y="9" width="4" height="12"></rect>
                                    <circle cx="4" cy="4" r="2"></circle>
                                </svg>
                                <p class="text-muted mb-3">Post preview not available</p>
                                <a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    View on LinkedIn
                                </a>
                            </div>
                        `;
                    }
                } else {
                    embedContainer.innerHTML = `
                        <div class="text-center py-12 border border-slate-200 rounded">
                            <p class="text-muted">No LinkedIn URL available</p>
                            ${this.post.post_title ? `<p class="text-sm mt-2">${this.post.post_title}</p>` : ''}
                        </div>
                    `;
                }
            },
            
            renderMetrics() {
                const metricsContainer = document.getElementById('postMetrics');
                
                const totalEngagements = this.engagements.length;
                const followers = this.engagements.filter(e => e.person?.is_follower).length;
                const reactionTypes = {};
                
                this.engagements.forEach(e => {
                    const type = e.reaction_type || 'like';
                    reactionTypes[type] = (reactionTypes[type] || 0) + 1;
                });
                
                metricsContainer.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center p-3 bg-slate-50 rounded border border-slate-200">
                            <div class="text-xl font-semibold text-slate-900 text-mono">${totalEngagements}</div>
                            <div class="text-xs text-muted mt-1">Total</div>
                        </div>
                        <div class="text-center p-3 bg-blue-50 rounded border border-blue-200">
                            <div class="text-xl font-semibold text-blue-900 text-mono">${followers}</div>
                            <div class="text-xs text-muted mt-1">Followers</div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">Reactions</h4>
                        <div class="space-y-2">
                            ${Object.entries(reactionTypes).map(([type, count]) => `
                                <div class="flex items-center justify-between py-1">
                                    <span class="text-sm capitalize text-muted">${type}</span>
                                    <span class="text-sm font-medium text-mono">${count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            
            renderSignals() {
                const patternsContainer = document.getElementById('patternsAndSignals');
                
                // Analyze engagement patterns
                const titlePatterns = {};
                const companyPatterns = {};
                const peopleByScore = [];
                
                this.engagements.forEach(e => {
                    const title = (e.person?.title_override || e.person?.current_title || '').toLowerCase();
                    const company = e.person?.company_override || e.person?.current_company || 'Unknown';
                    
                    // Count title keywords
                    this.targetTitles.forEach(targetTitle => {
                        if (title.includes(targetTitle.toLowerCase())) {
                            titlePatterns[targetTitle] = (titlePatterns[targetTitle] || 0) + 1;
                        }
                    });
                    
                    // Count companies
                    if (company !== 'Unknown') {
                        companyPatterns[company] = (companyPatterns[company] || 0) + 1;
                    }
                    
                    // Collect people for top signal
                    if (e.person && e.person.engagement_score > 0) {
                        peopleByScore.push(e.person);
                    }
                });
                
                // Sort and get top patterns
                const topTitles = Object.entries(titlePatterns)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                
                const topCompanies = Object.entries(companyPatterns)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                
                // Get top signal person
                const topPerson = peopleByScore.sort((a, b) => b.engagement_score - a.engagement_score)[0];
                
                // Calculate stats
                const totalEngagements = this.engagements.length;
                const followers = this.engagements.filter(e => e.person?.is_follower).length;
                
                patternsContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Key Metrics -->
                        <div class="text-center p-4 bg-slate-50 rounded border border-slate-200">
                            <div class="text-2xl font-semibold text-slate-900 text-mono">${totalEngagements}</div>
                            <div class="text-xs text-muted mt-1">Total</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded border border-blue-200">
                            <div class="text-2xl font-semibold text-blue-900 text-mono">${followers}</div>
                            <div class="text-xs text-muted mt-1">Followers</div>
                        </div>
                        <div class="text-center p-4 bg-amber-50 rounded border border-amber-200">
                            <div class="text-sm font-semibold text-amber-900 text-truncate">${topTitles[0] ? topTitles[0][0] : '—'}</div>
                            <div class="text-xs text-muted mt-1">Top Title (${topTitles[0] ? topTitles[0][1] : 0})</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded border border-green-200">
                            <div class="text-sm font-semibold text-green-900 text-truncate">
                                ${topPerson ? topPerson.name.split(' ')[0] : '—'}
                            </div>
                            <div class="text-xs text-muted mt-1">Top Signal (${topPerson ? topPerson.engagement_score : 0})</div>
                        </div>
                    </div>
                    
                    <!-- Pattern Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">Top Companies (Organic)</h4>
                            <div class="space-y-2">
                                ${topCompanies.map(([company, count]) => `
                                    <div class="flex items-center justify-between py-1">
                                        <span class="data-pill medium text-truncate" style="max-width: 200px">${company}</span>
                                        <span class="text-sm font-medium text-mono">${count}</span>
                                    </div>
                                `).join('') || '<p class="text-sm text-muted">No patterns found</p>'}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">Top People (Organic)</h4>
                            <div class="space-y-2">
                                ${peopleByScore.slice(0, 3).map(person => `
                                    <div class="flex items-center justify-between py-1">
                                        <span class="text-sm">${person.name}</span>
                                        <span class="data-pill high">${person.engagement_score}</span>
                                    </div>
                                `).join('') || '<p class="text-sm text-muted">No high-value people found</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- LinkedIn Campaign Demographics -->
                    <div id="campaignDemographics" class="mt-6">
                        <!-- Campaign demographics will be loaded here -->
                    </div>
                `;
                
                // Load campaign demographics after rendering organic data
                this.loadCampaignDemographics();
            },
            
            async loadCampaignDemographics() {
                const campaignContainer = document.getElementById('campaignDemographics');
                
                try {
                    // First try to get post data from posts table directly
                    const { data: post, error: postError } = await supabaseClient
                        .from('posts')
                        .select('*')
                        .eq('id', this.postId)
                        .single();

                    if (postError) {
                        console.error('Error loading post:', postError);
                        campaignContainer.innerHTML = `
                            <div class="text-center py-6 border border-red-200 rounded bg-red-50">
                                <p class="text-sm text-red-600">Error loading post data: ${postError.message}</p>
                            </div>
                        `;
                        return;
                    }

                    // Check if post has campaign data (after migration this will work)
                    if (post.linkedin_campaign_id) {
                        // Get campaign demographics from the new demographics summary view
                        const { data: campaignDemographics, error: demographicsError } = await supabaseClient
                            .from('campaign_demographics_summary')
                            .select('*')
                            .eq('linkedin_campaign_id', post.linkedin_campaign_id)
                            .single();

                        if (campaignDemographics) {
                            // Convert database format to frontend format
                            const formattedDemographics = {
                                demographics: {
                                    COMPANY: campaignDemographics.top_companies || [],
                                    JOB_TITLE: campaignDemographics.top_job_titles || [],
                                    SENIORITY: campaignDemographics.seniority_breakdown || [],
                                    INDUSTRY: campaignDemographics.industry_breakdown || []
                                }
                            };
                            
                            const enhancedPost = {
                                ...post,
                                campaign_name: campaignDemographics.campaign_name,
                                campaign_spend: campaignDemographics.total_spend,
                                campaign_impressions: campaignDemographics.total_impressions,
                                campaign_clicks: campaignDemographics.total_clicks,
                                campaign_ctr: campaignDemographics.overall_ctr,
                                campaign_cpc: campaignDemographics.overall_cpc,
                                actual_cost_per_engagement: post.true_cost_per_engagement
                            };
                            
                            this.renderCampaignDemographics(formattedDemographics, enhancedPost);
                            return;
                        }
                    }

                    // For demo purposes, show mock data if this is a Vucko post
                    if (post.url && post.url.includes('andrewvucko')) {
                        campaignContainer.innerHTML = `
                            <div class="border border-blue-200 rounded bg-blue-50 p-4 mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fab fa-linkedin text-blue-600"></i>
                                    <h3 class="text-sm font-semibold text-blue-900">LinkedIn Campaign Intelligence (Demo)</h3>
                                </div>
                                <p class="text-xs text-blue-700">
                                    This post can be enhanced with campaign data after running migration 005 and campaign sync.
                                </p>
                                <button onclick="app.showDemoCampaignData()" class="mt-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                    Show Demo Campaign Data
                                </button>
                            </div>
                        `;
                        return;
                    }

                    // Default: No campaign data
                    campaignContainer.innerHTML = `
                        <div class="text-center py-6 border border-slate-200 rounded bg-slate-50">
                            <p class="text-sm text-muted">No LinkedIn campaign data available for this post</p>
                            <p class="text-xs text-muted mt-1">Run campaign sync to enhance with LinkedIn data</p>
                            <div class="mt-3">
                                <button onclick="app.runDatabaseMigration()" class="px-3 py-1 bg-slate-600 text-white text-xs rounded hover:bg-slate-700 mr-2">
                                    Run Migration 005
                                </button>
                                <button onclick="app.showDemoCampaignData()" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                    Show Demo Data
                                </button>
                            </div>
                        </div>
                    `;

                } catch (error) {
                    console.error('Error loading campaign demographics:', error);
                    campaignContainer.innerHTML = `
                        <div class="text-center py-6 border border-red-200 rounded bg-red-50">
                            <p class="text-sm text-red-600">Error loading campaign data: ${error.message}</p>
                            <p class="text-xs text-muted mt-1">Database may need migration 005</p>
                        </div>
                    `;
                }
            },

            // Show demo campaign data for testing
            showDemoCampaignData() {
                const mockDemographics = this.getMockCampaignDemographics();
                const mockPost = {
                    campaign_name: 'Q2 2025 Thought Leadership',
                    campaign_spend: 2500.00,
                    campaign_impressions: 25430,
                    actual_cost_per_engagement: 15.43,
                    engagement_count: 162,
                    unique_person_count: 89
                };
                this.renderCampaignDemographics(mockDemographics, mockPost);
            },

            // Run database migration (this would need admin access in production)
            async runDatabaseMigration() {
                alert('This would run migration 005 to add campaign data columns to existing tables. In production, this requires database admin access.');
            },

            async fetchCampaignDemographics(campaignId) {
                try {
                    // Use our LinkedIn API service to get campaign analytics with demographic breakdowns
                    if (typeof window.linkedInAPI === 'undefined') {
                        console.warn('LinkedIn API service not available, using mock data');
                        // Return mock data for development
                        return this.getMockCampaignDemographics();
                    }

                    // Fetch analytics with demographic pivots using the enhanced method
                    const demographics = await window.linkedInAPI.getCampaignDemographics(campaignId, {
                        pivots: ['COMPANY', 'JOB_TITLE', 'SENIORITY', 'INDUSTRY'],
                        metrics: ['impressions', 'clicks', 'spend'],
                        timeRange: { 
                            start: { year: 2024, month: 1, day: 1 },
                            end: { year: 2025, month: 12, day: 31 }
                        }
                    });

                    return demographics;

                } catch (error) {
                    console.error('Error fetching campaign demographics:', error);
                    // Fallback to mock data
                    return this.getMockCampaignDemographics();
                }
            },

            getMockCampaignDemographics() {
                // Mock data for development and testing
                return {
                    demographics: {
                        COMPANY: [
                            { label: 'Microsoft', impressions: 5420, clicks: 234, spend: 1250.50 },
                            { label: 'Google', impressions: 4832, clicks: 198, spend: 1100.25 },
                            { label: 'Amazon', impressions: 4156, clicks: 167, spend: 950.75 },
                            { label: 'Meta', impressions: 3845, clicks: 145, spend: 875.40 },
                            { label: 'Salesforce', impressions: 3234, clicks: 132, spend: 750.60 }
                        ],
                        JOB_TITLE: [
                            { label: 'Software Engineer', impressions: 3456, clicks: 178, spend: 825.30 },
                            { label: 'Product Manager', impressions: 2987, clicks: 145, spend: 712.80 },
                            { label: 'Engineering Manager', impressions: 2543, clicks: 124, spend: 615.45 },
                            { label: 'Senior Software Engineer', impressions: 2234, clicks: 98, spend: 545.20 },
                            { label: 'Technical Lead', impressions: 1987, clicks: 87, spend: 478.65 }
                        ],
                        SENIORITY: [
                            { label: 'Mid-Senior level', impressions: 8765, clicks: 354, spend: 2100.75 },
                            { label: 'Senior level', impressions: 6543, clicks: 287, spend: 1650.40 },
                            { label: 'Entry level', impressions: 4321, clicks: 198, spend: 1025.60 },
                            { label: 'Executive', impressions: 2109, clicks: 89, spend: 650.25 }
                        ],
                        INDUSTRY: [
                            { label: 'Computer Software', impressions: 7654, clicks: 312, spend: 1875.80 },
                            { label: 'Information Technology', impressions: 5432, clicks: 234, spend: 1320.50 },
                            { label: 'Financial Services', impressions: 4321, clicks: 187, spend: 1050.25 },
                            { label: 'Consulting', impressions: 3210, clicks: 145, spend: 780.40 }
                        ]
                    }
                };
            },

            renderCampaignDemographics(demographics, enhancedPost) {
                const campaignContainer = document.getElementById('campaignDemographics');
                
                // Process demographics data
                const topCompanies = this.processDemographicData(demographics, 'COMPANY');
                const topTitles = this.processDemographicData(demographics, 'JOB_TITLE');
                const topIndustries = this.processDemographicData(demographics, 'INDUSTRY');
                const topSeniority = this.processDemographicData(demographics, 'SENIORITY');

                campaignContainer.innerHTML = `
                    <div class="border border-blue-200 rounded bg-blue-50 p-4 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fab fa-linkedin text-blue-600"></i>
                            <h3 class="text-sm font-semibold text-blue-900">LinkedIn Campaign Intelligence</h3>
                        </div>
                        <p class="text-xs text-blue-700">
                            Campaign: <strong>${enhancedPost.campaign_name || 'Q2 2025 Thought Leadership'}</strong> • 
                            Spend: <strong>$${(enhancedPost.campaign_spend || 0).toFixed(2)}</strong> • 
                            Impressions: <strong>${(enhancedPost.campaign_impressions || 0).toLocaleString()}</strong>
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 bg-blue-500 rounded"></span>
                                Top Companies (Campaign)
                            </h4>
                            <div class="space-y-2">
                                ${topCompanies.map(({ label, value, percentage }) => `
                                    <div class="flex items-center justify-between py-1">
                                        <span class="data-pill high text-truncate" style="max-width: 200px" title="${label}">${label}</span>
                                        <div class="text-right">
                                            <span class="text-sm font-medium text-mono">${value.toLocaleString()}</span>
                                            <div class="text-xs text-blue-600">${percentage}% of spend</div>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-sm text-muted">No campaign data available</p>'}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 bg-blue-500 rounded"></span>
                                Top Titles (Campaign)
                            </h4>
                            <div class="space-y-2">
                                ${topTitles.map(({ label, value, percentage }) => `
                                    <div class="flex items-center justify-between py-1">
                                        <span class="text-sm text-truncate" style="max-width: 200px" title="${label}">${label}</span>
                                        <div class="text-right">
                                            <span class="text-sm font-medium text-mono">${value.toLocaleString()}</span>
                                            <div class="text-xs text-blue-600">${percentage}% of reach</div>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-sm text-muted">No campaign data available</p>'}
                            </div>
                        </div>
                    </div>

                    <!-- Additional Campaign Demographics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 bg-purple-500 rounded"></span>
                                Top Industries (Campaign)
                            </h4>
                            <div class="space-y-2">
                                ${topIndustries.slice(0, 3).map(({ label, value, percentage }) => `
                                    <div class="flex items-center justify-between py-1">
                                        <span class="text-sm text-truncate" style="max-width: 200px">${label}</span>
                                        <span class="text-xs text-purple-600">${percentage}%</span>
                                    </div>
                                `).join('') || '<p class="text-sm text-muted">No industry data</p>'}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 bg-green-500 rounded"></span>
                                Seniority Levels (Campaign)
                            </h4>
                            <div class="space-y-2">
                                ${topSeniority.map(({ label, value, percentage }) => `
                                    <div class="flex items-center justify-between py-1">
                                        <span class="text-sm">${label}</span>
                                        <span class="text-xs text-green-600">${percentage}%</span>
                                    </div>
                                `).join('') || '<p class="text-sm text-muted">No seniority data</p>'}
                            </div>
                        </div>
                    </div>

                    <!-- Performance Comparison -->
                    <div class="mt-6 p-4 bg-gray-50 rounded border">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">Campaign vs Organic Performance</h4>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-lg font-semibold text-blue-600">$${(enhancedPost.actual_cost_per_engagement || 0).toFixed(4)}</div>
                                <div class="text-xs text-muted">Cost/Engagement</div>
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-green-600">${(enhancedPost.engagement_count || 0)}</div>
                                <div class="text-xs text-muted">Total Engagements</div>
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-purple-600">${(enhancedPost.unique_person_count || 0)}</div>
                                <div class="text-xs text-muted">Unique People</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            processDemographicData(demographics, pivot) {
                if (!demographics || !demographics.demographics || !demographics.demographics[pivot]) {
                    return [];
                }

                // Get the demographic data for the specified pivot
                const pivotData = demographics.demographics[pivot]
                    .map(item => ({
                        label: item.label || 'Unknown',
                        value: item.impressions || 0,
                        spend: item.spend || 0,
                        clicks: item.clicks || 0
                    }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 5);

                // Calculate percentages based on total impressions
                const totalValue = pivotData.reduce((sum, item) => sum + item.value, 0);
                
                return pivotData.map(item => ({
                    ...item,
                    percentage: totalValue > 0 ? Math.round((item.value / totalValue) * 100) : 0
                }));
            },
            
            populateFilters() {
                // Get unique companies and titles
                const companies = new Set();
                const titles = new Set();
                
                this.engagements.forEach(e => {
                    const company = e.person?.company_override || e.person?.current_company;
                    const title = e.person?.title_override || e.person?.current_title;
                    
                    if (company) companies.add(company);
                    if (title) titles.add(title);
                });
                
                // Populate company filter
                const companyFilter = document.getElementById('companyFilter');
                Array.from(companies).sort().forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    companyFilter.appendChild(option);
                });
                
                // Populate title filter
                const titleFilter = document.getElementById('titleFilter');
                Array.from(titles).sort().forEach(title => {
                    const option = document.createElement('option');
                    option.value = title;
                    option.textContent = title;
                    titleFilter.appendChild(option);
                });
            },
            
            setFilter(filter) {
                this.currentFilter = filter;
                
                // Update tab styles
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.applyFilters();
            },
            
            applyFilters() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const companyFilter = document.getElementById('companyFilter').value;
                const titleFilter = document.getElementById('titleFilter').value;
                const statusFilter = document.getElementById('actionStatusFilter').value;
                
                this.filteredEngagements = this.engagements.filter(engagement => {
                    const person = engagement.person;
                    if (!person) return false;
                    
                    // Apply main filter
                    if (this.currentFilter === 'followers' && !person.is_follower) return false;
                    if (this.currentFilter === 'target_titles') {
                        const title = (person.title_override || person.current_title || '').toLowerCase();
                        const hasTargetTitle = this.targetTitles.some(t => title.includes(t.toLowerCase()));
                        if (!hasTargetTitle) return false;
                    }
                    if (this.currentFilter === 'high_value' && person.engagement_score < 5) return false;
                    if (this.currentFilter === 'notable' && !person.is_notable) return false;
                    
                    // Apply search
                    if (searchTerm) {
                        const searchableText = [
                            person.name,
                            person.title_override || person.current_title,
                            person.company_override || person.current_company,
                            person.headline
                        ].join(' ').toLowerCase();
                        
                        if (!searchableText.includes(searchTerm)) return false;
                    }
                    
                    // Apply filters
                    if (companyFilter && (person.company_override || person.current_company) !== companyFilter) return false;
                    if (titleFilter && (person.title_override || person.current_title) !== titleFilter) return false;
                    if (statusFilter && engagement.action_status !== statusFilter) return false;
                    
                    return true;
                });
                
                // Update counts
                this.updateCounts();
                
                // Reset to page 1
                this.currentPage = 1;
                this.renderTable();
            },
            
            updateCounts() {
                document.getElementById('countAll').textContent = this.engagements.length;
                document.getElementById('countFollowers').textContent = this.engagements.filter(e => e.person?.is_follower).length;
                document.getElementById('countTargetTitles').textContent = this.engagements.filter(e => {
                    const title = (e.person?.title_override || e.person?.current_title || '').toLowerCase();
                    return this.targetTitles.some(t => title.includes(t.toLowerCase()));
                }).length;
                document.getElementById('countHighValue').textContent = this.engagements.filter(e => e.person?.engagement_score >= 5).length;
                document.getElementById('countNotable').textContent = this.engagements.filter(e => e.person?.is_notable).length;
            },
            
            renderTable() {
                const tbody = document.getElementById('engagementsTable');
                const start = (this.currentPage - 1) * this.pageSize;
                const end = start + this.pageSize;
                const pageEngagements = this.filteredEngagements.slice(start, end);
                
                if (pageEngagements.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-muted">
                                ${this.engagements.length === 0 ? 'Loading engagements...' : 'No engagements found matching your filters'}
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = pageEngagements.map(engagement => {
                    const person = engagement.person;
                    const title = person.title_override || person.current_title || person.headline || '—';
                    const company = person.company_override || person.current_company || '—';
                    const leadStatus = person.lead_status || '';
                    const isNotable = person.is_notable || false;
                    
                    return `
                        <tr onclick="window.location.href='person-detail.html?id=${person.id}'" class="cursor-pointer hover:bg-slate-50">
                            <td>
                                <div class="flex items-center gap-3">
                                    ${person.profile_picture ? 
                                        `<img src="${person.profile_picture}" 
                                             alt="${person.name}" 
                                             class="profile-photo"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'profile-placeholder\\'><svg class=\\'icon icon-sm\\' viewBox=\\'0 0 24 24\\'><path d=\\'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\\'></path><circle cx=\\'12\\' cy=\\'7\\' r=\\'4\\'></circle></svg></div>'">` :
                                        '<div class="profile-placeholder"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>'
                                    }
                                    <div class="min-w-0 flex-1">
                                        <div class="font-medium text-sm text-truncate text-strong">${person.name}</div>
                                        ${person.is_follower ? '<div class="text-xs text-blue-600 mt-1">Follower</div>' : ''}
                                    </div>
                                </div>
                            </td>
                            <td class="text-sm text-truncate">${title}</td>
                            <td class="text-sm text-truncate">${company}</td>
                            <td>
                                ${this.renderEngagementHeat(person.engagement_score || 0)}
                            </td>
                            <td>
                                <select class="control-select" 
                                        onchange="app.updateLeadStatus(${person.id}, this.value)"
                                        value="${leadStatus}">
                                    <option value="">—</option>
                                    <option value="nurturing" ${leadStatus === 'nurturing' ? 'selected' : ''}>Nurturing</option>
                                    <option value="to_follow_up" ${leadStatus === 'to_follow_up' ? 'selected' : ''}>Follow Up</option>
                                    <option value="add_on_linkedin" ${leadStatus === 'add_on_linkedin' ? 'selected' : ''}>Add on LI</option>
                                </select>
                            </td>
                            <td>
                                <div class="flex items-center gap-1">
                                    <button onclick="app.toggleNotable(${person.id})" 
                                            class="action-button ${isNotable ? 'active' : ''}" 
                                            title="${isNotable ? 'Remove from notable' : 'Mark as notable'}">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
                                        </svg>
                                    </button>
                                    <a href="${person.linkedin_url}" target="_blank" 
                                       class="action-button"
                                       title="View LinkedIn Profile">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                                            <rect x="2" y="9" width="4" height="12"></rect>
                                            <circle cx="4" cy="4" r="2"></circle>
                                        </svg>
                                    </a>
                                    <button onclick="app.updateActionStatus(${engagement.id}, 'messaged')" 
                                            class="action-button" 
                                            title="Mark as messaged">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                            <polyline points="22,6 12,13 2,6"></polyline>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Update pagination info
                document.getElementById('showingFrom').textContent = start + 1;
                document.getElementById('showingTo').textContent = Math.min(end, this.filteredEngagements.length);
                document.getElementById('totalResults').textContent = this.filteredEngagements.length;
            },
            
            getStatusIcon(status) {
                const icons = {
                    new: '<i class="fas fa-circle text-xs"></i>',
                    viewed: '<i class="fas fa-eye text-xs"></i>',
                    messaged: '<i class="fas fa-envelope text-xs"></i>',
                    responded: '<i class="fas fa-reply text-xs"></i>',
                    meeting: '<i class="fas fa-calendar text-xs"></i>'
                };
                return icons[status] || icons.new;
            },
            
            getStatusLabel(status) {
                const labels = {
                    new: 'New',
                    viewed: 'Viewed',
                    messaged: 'Messaged',
                    responded: 'Responded',
                    meeting: 'Meeting'
                };
                return labels[status] || 'New';
            },
            
            async updateActionStatus(engagementId, status) {
                const { error } = await supabaseClient
                    .from('engagements')
                    .update({ action_status: status })
                    .eq('id', engagementId);
                
                if (error) {
                    console.error('Error updating status:', error);
                    return;
                }
                
                // Update local data
                const engagement = this.engagements.find(e => e.id === engagementId);
                if (engagement) {
                    engagement.action_status = status;
                }
                
                this.renderTable();
            },
            
            previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.renderTable();
                }
            },
            
            nextPage() {
                const totalPages = Math.ceil(this.filteredEngagements.length / this.pageSize);
                if (this.currentPage < totalPages) {
                    this.currentPage++;
                    this.renderTable();
                }
            },
            
            toggleReviewMode() {
                this.reviewMode = !this.reviewMode;
                const panel = document.getElementById('reviewModePanel');
                
                if (this.reviewMode) {
                    panel.classList.remove('hidden');
                    this.populateTitleDiscovery();
                } else {
                    panel.classList.add('hidden');
                }
            },
            
            populateTitleDiscovery() {
                const container = document.getElementById('discoveredTitles');
                const titleCounts = {};
                
                // Count unique titles
                this.engagements.forEach(e => {
                    const title = e.person?.title_override || e.person?.current_title;
                    if (title && !this.targetTitles.some(t => title.toLowerCase().includes(t.toLowerCase()))) {
                        titleCounts[title] = (titleCounts[title] || 0) + 1;
                    }
                });
                
                // Sort by count
                const sortedTitles = Object.entries(titleCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 20);
                
                container.innerHTML = sortedTitles.map(([title, count]) => `
                    <label class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
                        <input type="checkbox" value="${title}" class="discovered-title">
                        <span class="flex-1 text-sm">${title}</span>
                        <span class="text-xs text-gray-500">${count}</span>
                    </label>
                `).join('');
            },
            
            addSelectedTitles() {
                const checkboxes = document.querySelectorAll('.discovered-title:checked');
                checkboxes.forEach(cb => {
                    if (!this.targetTitles.includes(cb.value)) {
                        this.targetTitles.push(cb.value);
                    }
                });
                
                // Reapply filters to update counts
                this.applyFilters();
                this.toggleReviewMode();
            },
            
            async exportEngagements() {
                const dataToExport = this.filteredEngagements.map(e => ({
                    name: e.person?.name,
                    title: e.person?.title_override || e.person?.current_title,
                    company: e.person?.company_override || e.person?.current_company,
                    linkedin_url: e.person?.linkedin_url,
                    is_follower: e.person?.is_follower ? 'Yes' : 'No',
                    reaction_type: e.reaction_type,
                    status: e.action_status || 'new',
                    engaged_at: new Date(e.engaged_at).toLocaleDateString()
                }));
                
                // Convert to CSV
                const headers = Object.keys(dataToExport[0]);
                const csv = [
                    headers.join(','),
                    ...dataToExport.map(row => headers.map(h => `"${row[h] || ''}"`).join(','))
                ].join('\n');
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `post-engagements-${this.postId}-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            renderEngagementHeat(score) {
                if (score >= 10) {
                    return '<span class="data-pill high">High</span>';
                } else if (score >= 5) {
                    return '<span class="data-pill medium">Medium</span>';
                } else if (score > 0) {
                    return '<span class="data-pill low">Low</span>';
                } else {
                    return '<span class="data-pill">New</span>';
                }
            },
            
            async updateLeadStatus(personId, status) {
                const { error } = await supabaseClient
                    .from('persons')
                    .update({ 
                        lead_status: status || null,
                        last_lead_update: new Date().toISOString()
                    })
                    .eq('id', personId);
                
                if (error) {
                    console.error('Error updating lead status:', error);
                    return;
                }
                
                // Update local data
                const engagement = this.engagements.find(e => e.person?.id === personId);
                if (engagement && engagement.person) {
                    engagement.person.lead_status = status;
                }
            },
            
            async toggleNotable(personId) {
                // Find current status
                const engagement = this.engagements.find(e => e.person?.id === personId);
                const currentStatus = engagement?.person?.is_notable || false;
                const newStatus = !currentStatus;
                
                const { error } = await supabaseClient
                    .from('persons')
                    .update({ 
                        is_notable: newStatus,
                        notable_reason: newStatus ? 'Marked during post analysis' : null
                    })
                    .eq('id', personId);
                
                if (error) {
                    console.error('Error updating notable status:', error);
                    return;
                }
                
                // Update local data
                if (engagement && engagement.person) {
                    engagement.person.is_notable = newStatus;
                }
                
                // Re-render table
                this.renderTable();
                this.updateCounts();
            },
            
            sortBy(field) {
                // Toggle sort direction if same field
                if (this.currentSort === field) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.currentSort = field;
                    this.sortDirection = 'asc';
                }
                
                // Sort the filtered engagements
                this.filteredEngagements.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch (field) {
                        case 'name':
                            valueA = a.person?.name || '';
                            valueB = b.person?.name || '';
                            break;
                        case 'title':
                            valueA = a.person?.title_override || a.person?.current_title || '';
                            valueB = b.person?.title_override || b.person?.current_title || '';
                            break;
                        case 'company':
                            valueA = a.person?.company_override || a.person?.current_company || '';
                            valueB = b.person?.company_override || b.person?.current_company || '';
                            break;
                        case 'engagement_score':
                            valueA = a.person?.engagement_score || 0;
                            valueB = b.person?.engagement_score || 0;
                            break;
                    }
                    
                    if (field === 'engagement_score') {
                        // Numeric sort
                        return this.sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
                    } else {
                        // String sort
                        if (this.sortDirection === 'asc') {
                            return valueA.localeCompare(valueB);
                        } else {
                            return valueB.localeCompare(valueA);
                        }
                    }
                });
                
                this.renderTable();
            },
            
        };
        
        // Navigation functions
        function navigateTo(page) {
            if (page === 'posts') return; // Already on post detail
            window.location.href = `index.html#${page}`;
        }
        
        // Load sidebar component
        async function loadSidebar() {
            try {
                const response = await fetch('components/sidebar.html');
                const sidebarHTML = await response.text();
                document.getElementById('sidebar-container').innerHTML = sidebarHTML;
            } catch (error) {
                console.error('Failed to load sidebar:', error);
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Load sidebar first
            await loadSidebar();
            
            window.app = app;
            app.init();
        });
    </script>
</body>
</html>